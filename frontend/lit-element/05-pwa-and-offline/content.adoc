= PWA and offline

:title: PWA and offline
:authors: marcus
:type: text, video
:topic: frontend
:tags: LitElement, PWA, offline, webpack
:description: Building and serving a LitElement project in production as a PWA.
:repo: https://github.com/vaadin-learning-center/lit-element-tutorial-05-pwa-and-offline
:linkattrs:
:imagesdir: ./images

In the first four tutorials in this series, we've built an app with LitElement, using Redux for state management, Vaadin Router for navigation and Webpack for building and code splitting. 

In this final tutorial, we turn the application into an offline-capable Progressive Web App. 

If you didn't do the previous steps of the tutorial, you can check out the code from the previous step as a starter:

https://github.com/learn-vaadin/lit-element-tutorial-04-navigation-and-code-splitting[Source code for step 4, role="cta"]

TIP: You can find out more about Progressive Web Apps on Vaadin's https://vaadin.com/pwa[PWA page^]. 


== Adding a Web App Manifest
The first step in turning an app into a PWA is adding a manifest file to identify the app to the browser. 

In the `src` folder, create a file `manifest.webmanifest`:

.`*src/manifest.webmanifest*`
[source,json]
----
{
  "name": "Todo App",
  "short_name": "Todo",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#2A3443",
  "description": "LitElement tutorial",
  "theme_color": "#2A3443",
  "icons": [
    {
      "src": "./img/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "./img/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
----

The manifest file collects all the relevant info about your app into a single file. Link the file from `index.html`:

.`*src/index.html*`
[source,diff]
----
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Todo</title>
+    <link rel="manifest" href="./manifest.webmanifest" />
----

Add the manifest file to the list of files Webpack copies over during the build:

.`*webpack.config.js*`
[source,diff]
----
new CopyWebpackPlugin(
-  [{ from: 'src/img', to: 'img/' }],
+  [{ from: 'src/img', to: 'img/' }, 'src/manifest.webmanifest'],
  { ignore: ['.DS_Store'] }
)
----

== Adding a ServiceWorker
The second step in turning an app into a PWA is adding a ServiceWorker. The ServiceWorker is a script that sits between your app and the network that can be used to cache and serve resources, so the app loads fast and works reliably regardless of the network conditions. 

In this project, we are using https://developers.google.com/web/tools/workbox/[Workbox^] for generating the service worker. It is a widely used library for building production-grade ServiceWorkers. The project Webpack configuration uses the Workbox plugin to automatically generate a ServiceWorker that caches and serves all the static assets. 

Open `sw.js` in the `src` folder.

.`*src/sw.js*`
[source,javascript]
----
if ('workbox' in self) {
  workbox.precaching.precacheAndRoute(self.__precacheManifest || []);
}
----

Webpack only adds a ServiceWorker when running the `prod` or `dev:sw` scripts. Detect whether or not workbox is loaded. If it is, call `precacheAndRoute` with `self.__precacheManifest` which is an array of assets generated by the build script. 

Load the ServiceWorker file in `index.js`: 

.`*src/sw.js*`
[source,diff]
----
window.addEventListener('load', () => {
  initRouter();
+  registerSW();
});
----

.`*src/sw.js*`
[source,javascript]
----
async function registerSW() {
  if ('serviceWorker' in navigator) { //<1>
    try {
      await navigator.serviceWorker.register('./sw.js'); //<2>
    } catch (e) {
      console.log('ServiceWorker registration failed. Sorry about that.', e);
    }
  } else {
    console.log('Your browser does not support ServiceWorker.');
  }
}
----
<1> Ensure that the browser supports ServiceWorker before trying to register it. 
<2> Register the ServiceWorker. Note that the path of the ServiceWorker determines its scope.

Start the app with the ServiceWorker enabled, and you should see the loaded ServiceWorker in the "Application" tab of DevTools. You should also be able to go offline and refresh the page and verify that the app still loads.

[source, terminal]
$ npm run dev:sw

.Going offline
image::sw-offline.gif[Going offline]


== Saving the state to localstorage
The application can now start offline, but it doesn't persist the todos between runs. 

Because the state of the application is in a central Redux store, we have a clean way of persisting and loading the state in localstorage. 

Start by adding functions for saving and loading the state in `store.js`.

.`*src/redux/store.js*`
[source,javascript]
----
const STORAGE_KEY = '__todo_app__';

const saveState = state => {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
};

const loadState = () => {
  const json = localStorage.getItem(STORAGE_KEY);
  return json ? JSON.parse(json) : undefined;
};
----

Then, load the state from localstorage when creating the store:

.`*src/redux/store.js*`
[source,diff]
----
export const store = createStore(
  reducer,
+  loadState(),
  window.__REDUX_DEVTOOLS_EXTENSION__ && window.__REDUX_DEVTOOLS_EXTENSION__()
);
----

Finally, subscribe to the store to call `saveState` on any state changes. 

.`*src/redux/store.js*`
[source,javascript]
----
store.subscribe(() => {
  saveState(store.getState());
});
----

Now, if you rerun the application, you should be able to see the application state persists between refreshes.

.State persisted between refreshes
image::persisted-state.gif[State persisted between refreshes]

== Conclusion 
This five-part tutorial has walked you through building a PWA with LitElement and Redux. 

You can find the finished code in GitHub:

https://github.com/learn-vaadin/lit-element-tutorial-05-pwa-and-offline[Source code for this tutorial, role="cta"]

== Further reading
Here are some helpful resources for continued learning. 

* https://lit-element.polymer-project.org/[LitElement^]
* https://lit-html.polymer-project.org/[lit-html^]
* https://pwa-starter-kit.polymer-project.org/[PWA Starter Kit^]
* https://redux.js.org/[Redux docs^]
* https://developers.google.com/web/tools/workbox/guides/get-started[Workbox guide^]
* https://webpack.js.org/concepts/[Webpack docs^]

== Let us know what you think!
As always, if you have questions or suggestions, feel free to comment below!